<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>School Ops System - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏°‡∏≤‡∏ö‡∏≠‡∏≥‡∏°‡∏§‡∏ï</title>
    
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- 3. Load React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.min.js"></script>
    
    <!-- 5. Load Babel for JSX/TSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root {
        --glass-border: rgba(56, 189, 248, 0.2);
      }

      body {
        font-family: 'Sarabun', sans-serif;
        background-color: #f1f5f9;
        /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á: Grid Pattern + Gradient ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ü‡πâ‡∏≤‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏ï‡∏≤ */
        background-image: 
          radial-gradient(circle at 50% 0%, rgba(255,255,255,0.8) 0%, transparent 80%),
          linear-gradient(rgba(148, 163, 184, 0.1) 1px, transparent 1px),
          linear-gradient(90deg, rgba(148, 163, 184, 0.1) 1px, transparent 1px);
        background-size: 100% 100%, 40px 40px, 40px 40px;
        background-attachment: fixed;
        color: #334155;
        overflow-x: hidden;
      }

      .font-tech { font-family: 'Rajdhani', sans-serif; }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: rgba(203, 213, 225, 0.3); }
      ::-webkit-scrollbar-thumb { background: rgba(100, 116, 139, 0.5); border-radius: 99px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(71, 85, 105, 0.8); }

      /* Glass Panel Styles */
      .glass-panel {
        background: rgba(15, 23, 42, 0.94);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.1), 0 20px 40px -12px rgba(15, 23, 42, 0.4);
        color: #f1f5f9;
      }
      
      .hud-card {
        background: rgba(30, 41, 59, 0.7);
        border: 1px solid rgba(255, 255, 255, 0.08);
        transition: all 0.2s ease-out;
        color: #f8fafc;
      }
      .hud-card:hover {
        background: rgba(51, 65, 85, 0.9);
        border-color: rgba(56, 189, 248, 0.4);
        transform: translateY(-2px);
        box-shadow: 0 10px 25px -5px rgba(8, 145, 178, 0.2);
      }

      .text-glow { text-shadow: 0 0 15px rgba(56, 189, 248, 0.6); }
      button:active { transform: scale(0.98); }

      /* Animations */
      @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }
      @keyframes progressFill { from { width: 0%; } to { width: 100%; } }
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes textShimmer { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
      @keyframes scanLine { 0% { transform: translateY(-100%); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(500%); opacity: 0; } }

      .animate-float { animation: float 6s ease-in-out infinite; }
      .animate-float-delayed { animation: float 8s ease-in-out infinite; animation-delay: 2s; }
      .stagger-item { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; }
      .animate-text-shimmer { background-size: 200% auto; animation: textShimmer 3s linear infinite; }
      
      .scan-line-effect {
        position: absolute; top: 0; left: 0; right: 0; height: 20px;
        background: linear-gradient(to bottom, transparent, rgba(6, 182, 212, 0.5), transparent);
        opacity: 0.1; pointer-events: none; animation: scanLine 3s linear infinite;
      }

      .holding .progress-bar { animation: progressFill 1s linear forwards; }
      
      /* Print Styles override */
      @media print {
        body { background: white; color: black; }
        .glass-panel { background: white; color: black; border: none; box-shadow: none; }
        .print\:hidden { display: none !important; }
        .print\:block { display: block !important; }
        .print\:h-auto { height: auto !important; }
        .print\:overflow-visible { overflow: visible !important; }
        .print\:text-black { color: black !important; }
        .print\:border-gray-300 { border-color: #d1d5db !important; }
        .print\:bg-white { background-color: white !important; }
        .print\:opacity-100 { opacity: 1 !important; }
        .print\:line-clamp-none { -webkit-line-clamp: unset !important; }
        .print\:whitespace-normal { whitespace: normal !important; }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "vite": "https://aistudiocdn.com/vite@^7.2.6",
    "@vitejs/plugin-react": "https://aistudiocdn.com/@vitejs/plugin-react@^5.1.1"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef } = React;
        // Destructure Icons from LucideReact global
        const { 
            School, LogOut, Bell, Users, AlertTriangle, RefreshCw, Eye, Database, 
            Download, Upload, UserPlus, Check, X, Mail, Phone, AlertCircle, 
            Clock, CheckCircle2, Wrench, CheckCircle, MapPin, MessageSquare, 
            Plus, Trash2, Package, RotateCcw, Box, ArrowRight, Zap, Image: ImageIcon, 
            History, Lock, ShieldCheck, ClipboardList, GraduationCap, Hammer, 
            PaintRoller, HardHat, Settings, ClipboardPen, Loader2, Camera, BarChart3,
            Printer, Search, Filter, User, ArrowLeft, Info
        } = LucideReact;

        // --- CONSTANTS ---
        const BUILDINGS = [
            { id: "B1", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏õ.1-2" },
            { id: "B2", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏õ.4-5" },
            { id: "B3", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏õ.3 ‡πÅ‡∏•‡∏∞ 6" },
            { id: "B4", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" },
            { id: "B5", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á" },
            { id: "B6", name: "‡∏™‡∏ô‡∏≤‡∏°‡∏Å‡∏µ‡∏¨‡∏≤‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏®‡∏≤‡∏•‡∏≤‡πÄ‡∏â‡∏•‡∏¥‡∏°‡∏û‡∏£‡∏∞‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥" },
            { id: "B7", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•‡πÉ‡∏´‡∏°‡πà" },
            { id: "B8", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•" },
            { id: "B9", name: "‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏®‡∏¥‡∏•‡∏õ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°" },
            { id: "B10", name: "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" },
            { id: "B11", name: "‡∏´‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°" },
            { id: "B12", name: "‡∏´‡πâ‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå" },
            { id: "B13", name: "‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 1" },
            { id: "B14", name: "‡πÇ‡∏£‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ 2" },
            { id: "B15", name: "‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•" },
            { id: "B16", name: "‡πÅ‡∏ü‡∏•‡∏ï‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏Ñ‡∏£‡∏π" },
            { id: "B17", name: "‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏Ñ‡∏£‡∏π (‡∏£‡∏∞‡∏ö‡∏∏‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà)" },
            { id: "B18", name: "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏õ.4-5" },
            { id: "B19", name: "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ‡∏õ.1-2" },
            { id: "B20", name: "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" },
            { id: "B21", name: "‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≤‡∏≠‡∏≥‡∏°‡∏§‡∏ï" }
        ];

        const INITIAL_TEAMS = [
            { id: 1, name: "‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á A (‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)", status: "Available", currentIncidentId: null },
            { id: 2, name: "‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á B (‡∏õ‡∏£‡∏∞‡∏õ‡∏≤/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)", status: "Available", currentIncidentId: null },
            { id: 3, name: "‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á C (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á)", status: "Available", currentIncidentId: null },
            { id: 4, name: "‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á D (‡πÅ‡∏≠‡∏£‡πå/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®)", status: "Available", currentIncidentId: null }
        ];

        const AVAILABLE_PARTS = [
            { id: 'p1', name: '‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏ü LED ‡∏¢‡∏≤‡∏ß', unit: '‡∏´‡∏•‡∏≠‡∏î' },
            { id: 'p2', name: '‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏ü LED ‡∏Å‡∏•‡∏°', unit: '‡∏´‡∏•‡∏≠‡∏î' },
            { id: 'p3', name: '‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó‡πÄ‡∏ï‡∏≠‡∏£‡πå', unit: '‡∏ï‡∏±‡∏ß' },
            { id: 'p4', name: '‡πÄ‡∏ó‡∏õ‡∏û‡∏±‡∏ô‡∏™‡∏≤‡∏¢‡πÑ‡∏ü', unit: '‡∏°‡πâ‡∏ß‡∏ô' },
            { id: 'p5', name: '‡∏Å‡πä‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏ó‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', unit: '‡∏ï‡∏±‡∏ß' },
            { id: 'p6', name: '‡πÄ‡∏ó‡∏õ‡∏û‡∏±‡∏ô‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏ß', unit: '‡∏°‡πâ‡∏ß‡∏ô' },
            { id: 'p7', name: '‡∏ó‡πà‡∏≠ PVC 1/2 ‡∏ô‡∏¥‡πâ‡∏ß', unit: '‡πÄ‡∏™‡πâ‡∏ô' },
            { id: 'p8', name: '‡∏Ç‡πâ‡∏≠‡∏ï‡πà‡∏≠ PVC', unit: '‡∏ï‡∏±‡∏ß' },
            { id: 'p9', name: '‡∏Å‡∏•‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏ï‡∏π', unit: '‡∏ä‡∏∏‡∏î' },
            { id: 'p10', name: '‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á', unit: '‡∏≠‡∏±‡∏ô' },
            { id: 'p11', name: '‡∏ö‡∏≤‡∏ô‡∏û‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ï‡∏π', unit: '‡∏ï‡∏±‡∏ß' },
            { id: 'p12', name: '‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Å‡∏±‡∏ô‡∏™‡∏ô‡∏¥‡∏°', unit: '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á' },
            { id: 'p13', name: '‡∏™‡∏≤‡∏¢‡∏¢‡∏≤‡∏á', unit: '‡πÄ‡∏°‡∏ï‡∏£' },
            { id: 'p14', name: '‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡πÅ‡∏≠‡∏£‡πå R32', unit: '‡∏ñ‡∏±‡∏á' },
            { id: 'p15', name: '‡πÅ‡∏Ñ‡∏õ‡∏Å‡∏≤‡∏£‡∏±‡∏ô (Capacitor)', unit: '‡∏ï‡∏±‡∏ß' },
            { id: 'p16', name: '‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏≠‡∏£‡πå', unit: '‡πÅ‡∏ú‡πà‡∏ô' }
        ];

        const TEACHER_GRADE_LEVELS = [
            "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2", "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3", "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1", "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 2",
            "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 3", "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4", "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 5", "‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏µ‡∏ó‡∏µ‡πà 6"
        ];

        const ADMIN_CREDENTIALS = { username: 'admin_mab', password: 'mab_admin2024' };
        
        const TECHNICIAN_ACCOUNTS = [
            { username: 'tech_elec', password: 'mab_tech1', name: '‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ä‡∏≤‡∏¢ (‡πÑ‡∏ü‡∏ü‡πâ‡∏≤)', teamId: 1 },
            { username: 'tech_water', password: 'mab_tech2', name: '‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏°‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå (‡∏õ‡∏£‡∏∞‡∏õ‡∏≤)', teamId: 2 },
            { username: 'tech_struct', password: 'mab_tech3', name: '‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏°‡∏õ‡∏≠‡∏á (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á)', teamId: 3 },
            { username: 'tech_air', password: 'mab_tech4', name: '‡∏ô‡∏≤‡∏¢‡∏ä‡πà‡∏≤‡∏á‡∏≠‡∏≥‡∏û‡∏• (‡πÅ‡∏≠‡∏£‡πå)', teamId: 4 },
        ];

        // --- UTILS ---
        let audioCtx = null;
        const playClickSound = () => {
            try {
                if (!audioCtx) {
                    const Ctx = window.AudioContext || window.webkitAudioContext;
                    if (Ctx) audioCtx = new Ctx();
                }
                if (!audioCtx) return;
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(2000, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.05);
                gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.05);
            } catch (e) { console.error("Audio failed", e); }
        };

        const formatRelativeTime = (timestamp) => {
            const now = Date.now();
            const diff = now - timestamp;
            const minute = 60 * 1000;
            const hour = 60 * minute;
            const day = 24 * hour;
            if (diff < minute) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
            if (diff < hour) return `${Math.floor(diff / minute)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            if (diff < day) return `${Math.floor(diff / hour)} ‡∏ä‡∏°. ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            if (diff < 2 * day) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡∏ô‡∏µ‡πâ';
            if (diff < 7 * day) return `${Math.floor(diff / day)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            return new Date(timestamp).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        };

        const formatFullDate = (timestamp) => {
            return new Date(timestamp).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });
        };

        const sendApprovalEmail = async (email, name) => {
            await new Promise(resolve => setTimeout(resolve, 800));
            console.log(`[EMAIL SERVICE] Sending to ${email}`);
            return true;
        };

        // --- COMPONENTS ---

        const SchoolLogo = ({ className = "w-full h-full" }) => (
            <School className={`${className} text-cyan-400`} strokeWidth={1.5} />
        );

        const ToastContainer = ({ toasts, removeToast }) => (
            <div className="fixed top-20 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                {toasts.map((toast) => (
                    <div key={toast.id} className={`pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-md min-w-[300px] animate-[slideInRight_0.3s_ease-out] ${toast.type === 'success' ? 'bg-emerald-950/90 border-emerald-500/50 text-emerald-100' : ''} ${toast.type === 'error' ? 'bg-red-950/90 border-red-500/50 text-red-100' : ''} ${toast.type === 'info' ? 'bg-blue-950/90 border-blue-500/50 text-blue-100' : ''}`}>
                        <div className={`p-1.5 rounded-full shrink-0 ${toast.type === 'success' ? 'bg-emerald-500/20 text-emerald-400' : ''} ${toast.type === 'error' ? 'bg-red-500/20 text-red-400' : ''} ${toast.type === 'info' ? 'bg-blue-500/20 text-blue-400' : ''}`}>
                            {toast.type === 'success' && <CheckCircle2 size={18} />}
                            {toast.type === 'error' && <AlertCircle size={18} />}
                            {toast.type === 'info' && <Info size={18} />}
                        </div>
                        <div className="flex-1 text-sm font-medium">{toast.message}</div>
                        <button onClick={() => removeToast(toast.id)} className="text-white/40 hover:text-white transition-colors"><X size={16} /></button>
                    </div>
                ))}
            </div>
        );

        const HoldButton = ({ onAction, children, className = '', progressClassName = 'bg-white/20', duration = 1000, disabled = false }) => {
            const [isHolding, setIsHolding] = useState(false);
            const timeoutRef = useRef(null);

            const startHold = () => {
                if (disabled) return;
                setIsHolding(true);
                playClickSound();
                timeoutRef.current = setTimeout(() => { triggerAction(); }, duration);
            };

            const endHold = () => {
                if (!isHolding) return;
                setIsHolding(false);
                if (timeoutRef.current) { clearTimeout(timeoutRef.current); timeoutRef.current = null; }
            };

            const triggerAction = () => {
                setIsHolding(false);
                playClickSound();
                onAction();
            };

            return (
                <button onMouseDown={startHold} onMouseUp={endHold} onMouseLeave={endHold} onTouchStart={startHold} onTouchEnd={endHold} disabled={disabled} className={`relative overflow-hidden group select-none ${className} ${isHolding ? 'holding' : ''} ${disabled ? 'opacity-50 cursor-not-allowed' : 'active:scale-95'}`} style={{ WebkitTapHighlightColor: 'transparent' }}>
                    <div className={`absolute inset-0 origin-left scale-x-0 transition-none ${progressClassName}`} style={{ animation: isHolding ? `progressFill ${duration}ms linear forwards` : 'none' }}></div>
                    <div className="relative z-10 pointer-events-none">{children}</div>
                </button>
            );
        };

        const Header = ({ user, onLogout, notificationCount = 0 }) => (
            <header className="fixed top-0 left-0 right-0 z-50 glass-panel border-b-0 border-b-slate-800/50">
                <div className="absolute bottom-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-cyan-500/50 to-transparent"></div>
                <div className="container mx-auto px-4 py-3 flex justify-between items-center gap-4">
                    <div className="flex items-center gap-3 group cursor-default">
                        <div className="relative w-12 h-14 flex items-center justify-center">
                            <div className="absolute inset-0 bg-cyan-500/20 blur-md rounded-full group-hover:bg-cyan-500/40 transition-all duration-500"></div>
                            <div className="w-full h-full relative z-10 drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]"><SchoolLogo /></div>
                        </div>
                        <div>
                            <h1 className="text-lg sm:text-xl font-bold leading-tight tracking-wide drop-shadow-md"><span className="bg-gradient-to-r from-cyan-300 via-blue-400 to-purple-400 bg-clip-text text-transparent animate-text-shimmer">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</span></h1>
                            <p className="text-[10px] sm:text-xs text-cyan-200/60 font-medium">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏°‡∏≤‡∏ö‡∏≠‡∏≥‡∏°‡∏§‡∏ï</p>
                        </div>
                    </div>
                    {user && (
                        <div className="flex items-center gap-3 sm:gap-5">
                            <div className="relative mr-1">
                                <button onClick={() => playClickSound()} className="text-slate-400 hover:text-cyan-400 transition-colors p-1.5 rounded-full hover:bg-cyan-900/20">
                                    <Bell size={20} className={notificationCount > 0 ? 'animate-pulse text-cyan-300' : ''} />
                                </button>
                                {notificationCount > 0 && <span className="absolute -top-0.5 -right-0.5 flex items-center justify-center min-w-[16px] h-[16px] px-1 text-[10px] font-bold text-white bg-red-500 border border-slate-900 rounded-full shadow-[0_0_10px_rgba(239,68,68,0.6)]">{notificationCount > 9 ? '9+' : notificationCount}</span>}
                            </div>
                            <div className="text-right hidden sm:block">
                                <div className="text-sm font-semibold text-slate-100 tracking-wide text-glow">{user.name}</div>
                                <div className="text-[10px] text-cyan-500/80 uppercase tracking-widest font-bold font-tech">{user.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : user.role === 'technician' ? '‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á' : '‡∏Ñ‡∏£‡∏π/‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£'}</div>
                            </div>
                            <div className="h-8 w-[1px] bg-gradient-to-b from-transparent via-slate-700 to-transparent hidden sm:block"></div>
                            <button onClick={() => { playClickSound(); onLogout(); }} className="group flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800/50 hover:bg-red-900/30 text-slate-300 hover:text-red-400 transition-all duration-300 border border-slate-700 hover:border-red-500/50" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö">
                                <LogOut size={16} className="group-hover:translate-x-0.5 transition-transform" />
                                <span className="hidden sm:inline text-xs font-medium">‡∏≠‡∏≠‡∏Å</span>
                            </button>
                        </div>
                    )}
                </div>
            </header>
        );

        const BuildingGrid = ({ incidents, selectedBuildingId, onSelectBuilding }) => {
            const getIncidentCount = (buildingId) => incidents.filter(i => i.buildingId === buildingId && i.status !== 'Done').length;
            const handleSelect = (id) => { playClickSound(); onSelectBuilding(id); };

            return (
                <div className="glass-panel rounded-xl p-5 h-full relative overflow-hidden flex flex-col">
                    <div className="absolute top-0 left-0 w-8 h-8 border-t border-l border-cyan-500/30 rounded-tl-xl pointer-events-none"></div>
                    <div className="absolute bottom-0 right-0 w-8 h-8 border-b border-r border-cyan-500/30 rounded-br-xl pointer-events-none"></div>
                    <div className="mb-4 flex justify-between items-end shrink-0">
                        <div><h2 className="text-lg font-bold text-white flex items-center gap-2 tracking-wider text-glow">‡πÅ‡∏ú‡∏ô‡∏ú‡∏±‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£</h2><p className="text-[10px] text-cyan-200/50 mt-1 uppercase tracking-widest font-tech">Select sector to filter data</p></div>
                        {selectedBuildingId && <button onClick={() => handleSelect(null)} className="text-[10px] text-red-400 border border-red-500/30 px-2 py-1 rounded hover:bg-red-500/10 transition-colors uppercase">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>}
                    </div>
                    <div className="overflow-y-auto custom-scrollbar flex-1 -mr-2 pr-2">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 xl:grid-cols-2 gap-3 pb-2">
                            {BUILDINGS.map(building => {
                                const count = getIncidentCount(building.id);
                                const isSelected = selectedBuildingId === building.id;
                                return (
                                    <button key={building.id} onClick={() => handleSelect(isSelected ? null : building.id)} className={`relative p-3 rounded border text-left transition-all duration-300 group overflow-hidden min-h-[70px] ${isSelected ? 'bg-cyan-900/30 border-cyan-500 shadow-[0_0_15px_rgba(34,211,238,0.15)]' : 'bg-slate-900/40 border-slate-700/50 hover:border-cyan-500/50 hover:bg-slate-800/60'}`}>
                                        {isSelected && <div className="absolute left-0 top-0 bottom-0 w-1 bg-cyan-400 shadow-[0_0_8px_rgba(34,211,238,0.8)]"></div>}
                                        <div className="flex flex-col h-full justify-between gap-1 relative z-10 pl-2">
                                            <span className={`text-xs font-bold tracking-wide leading-tight ${isSelected ? 'text-cyan-100' : 'text-slate-400 group-hover:text-cyan-200'}`}>{building.name}</span>
                                            {count > 0 && <span className="absolute top-2 right-2 flex items-center justify-center min-w-[1.25rem] h-5 px-1.5 text-[10px] font-bold text-white bg-red-600 border border-red-400 rounded shadow-[0_0_8px_rgba(239,68,68,0.6)] animate-pulse font-tech">{count}</span>}
                                            <div className={`text-[9px] font-mono ${isSelected ? 'text-cyan-400' : 'text-slate-600'} mt-auto font-tech uppercase`}>ID: {building.id}</div>
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const IncidentList = ({ incidents, onAssignClick, onCompleteClick, onDeleteClick, isAdmin = false }) => {
            const [statusFilter, setStatusFilter] = useState('All');
            const [priorityFilter, setPriorityFilter] = useState('All');
            const [searchQuery, setSearchQuery] = useState('');
            const [expandedImage, setExpandedImage] = useState(null);

            const filteredIncidents = incidents.filter(i => {
                if (statusFilter !== 'All' && i.status !== statusFilter) return false;
                if (priorityFilter !== 'All' && i.priority !== priorityFilter) return false;
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    return i.description.toLowerCase().includes(q) || i.buildingName.toLowerCase().includes(q) || i.roomNumber.toLowerCase().includes(q) || i.reporterName.toLowerCase().includes(q);
                }
                return true;
            });

            const displayList = filteredIncidents.sort((a, b) => {
                if (statusFilter === 'All') {
                    const statusWeight = { 'Pending': 2, 'In Progress': 1, 'Done': 0 };
                    if (statusWeight[a.status] !== statusWeight[b.status]) return statusWeight[b.status] - statusWeight[a.status];
                }
                const priorityWeight = { 'Critical': 3, 'High': 2, 'Medium': 1, 'Low': 0 };
                if (priorityWeight[a.priority] !== priorityWeight[b.priority]) return priorityWeight[b.priority] - priorityWeight[a.priority];
                return b.timestamp - a.timestamp;
            });

            const getPriorityBadge = (priority) => {
                switch (priority) {
                    case 'Critical': return <span className="flex items-center gap-1 text-[10px] font-bold px-2 py-0.5 rounded bg-red-500/10 text-red-400 border border-red-500/30 animate-pulse print:border-red-600 print:text-red-700"><AlertCircle size={10} /> ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</span>;
                    case 'High': return <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-orange-500/10 text-orange-400 border border-orange-500/30 print:border-orange-600 print:text-orange-700">‡∏™‡∏π‡∏á</span>;
                    case 'Medium': return <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/30 print:border-blue-600 print:text-blue-700">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>;
                    case 'Low': return <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-700/30 text-slate-400 border border-slate-600/30 print:border-slate-400 print:text-slate-600">‡∏ï‡πà‡∏≥</span>;
                }
            };

            const handlePrint = () => { playClickSound(); window.print(); };

            return (
                <div className="glass-panel rounded-xl flex flex-col h-full overflow-hidden border-slate-800 print:border-none print:shadow-none print:bg-white print:h-auto">
                    {expandedImage && <div className="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4" onClick={() => setExpandedImage(null)}><img src={expandedImage} className="max-w-full max-h-full rounded-lg shadow-2xl" /><button className="absolute top-4 right-4 text-white p-2"><X size={32} /></button></div>}
                    <div className="p-3 border-b border-white/5 bg-slate-900/40 space-y-3 backdrop-blur-sm z-20 print:hidden">
                        <div className="flex gap-2">
                            <div className="relative group flex-1">
                                <Search className="absolute left-3 top-2.5 text-slate-500 group-focus-within:text-cyan-400" size={16} />
                                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full bg-slate-950/80 border border-slate-700/50 rounded-lg pl-9 pr-3 py-2 text-sm text-white focus:border-cyan-500/50 outline-none" />
                            </div>
                            <button onClick={handlePrint} className="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg border border-slate-700"><Printer size={18} /></button>
                        </div>
                        <div className="flex gap-2">
                             <div className="flex items-center gap-2 bg-slate-950/50 border border-slate-700/50 rounded-lg px-3 py-1.5 w-full">
                                 <Filter size={14} className="text-slate-500" />
                                 <select value={priorityFilter} onChange={(e) => setPriorityFilter(e.target.value)} className="bg-transparent text-xs text-slate-300 w-full outline-none border-none">
                                     <option value="All">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option>
                                     <option value="Critical">üî¥ ‡∏ß‡∏¥‡∏Å‡∏§‡∏ï</option>
                                     <option value="High">üü† ‡∏™‡∏π‡∏á</option>
                                     <option value="Medium">üîµ ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option>
                                     <option value="Low">‚ö™Ô∏è ‡∏ï‡πà‡∏≥</option>
                                 </select>
                             </div>
                         </div>
                    </div>
                    <div className="hidden print:block p-4 border-b border-black text-center mb-4">
                        <h1 className="text-2xl font-bold text-black">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h1>
                        <p className="text-sm text-gray-600">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏°‡∏≤‡∏ö‡∏≠‡∏≥‡∏°‡∏§‡∏ï</p>
                        <p className="text-xs text-gray-500 mt-2">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: {new Date().toLocaleString('th-TH')}</p>
                    </div>
                    <div className="flex border-b border-white/5 bg-slate-900/60 z-10 print:hidden">
                        {['All', 'Pending', 'In Progress', 'Done'].map(f => (
                            <button key={f} onClick={() => { playClickSound(); setStatusFilter(f); }} className={`flex-1 py-3 text-[10px] sm:text-xs font-bold transition-all relative ${statusFilter === f ? 'text-cyan-400 bg-white/5' : 'text-slate-500 hover:text-slate-300'}`}>
                                {statusFilter === f && <div className="absolute top-0 left-0 right-0 h-[2px] bg-cyan-500 shadow-[0_0_10px_rgba(34,211,238,0.8)]"></div>}
                                {f === 'All' ? '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' : f === 'Pending' ? '‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£' : f === 'In Progress' ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°' : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'}
                            </button>
                        ))}
                    </div>
                    <div className="overflow-y-auto flex-1 p-3 space-y-2 custom-scrollbar bg-slate-950/20 print:overflow-visible print:bg-white print:p-0">
                        {displayList.length === 0 && (
                            <div className="flex flex-col items-center justify-center h-full py-12 text-slate-500 opacity-80 animate-in zoom-in duration-300">
                                <div className="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 border border-slate-700/50 shadow-inner"><ShieldCheck className="w-8 h-8 text-emerald-500/50" /></div>
                                <p className="font-tech text-sm uppercase tracking-widest font-bold text-slate-400">ALL SYSTEMS NOMINAL</p>
                                <p className="text-xs text-slate-600 mt-1">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</p>
                            </div>
                        )}
                        {displayList.map((incident, index) => {
                            const isDone = incident.status === 'Done';
                            const isPending = incident.status === 'Pending';
                            const isInProgress = incident.status === 'In Progress';
                            return (
                                <div key={incident.id} className={`relative rounded-lg p-3.5 border transition-all duration-200 group break-inside-avoid stagger-item ${isDone ? 'bg-slate-900/40 border-slate-800 opacity-60 hover:opacity-100 print:bg-white print:border-gray-300 print:opacity-100' : 'hud-card print:bg-white print:border-gray-300'}`} style={{ animationDelay: `${index * 0.05}s` }}>
                                    <div className="flex justify-between items-start gap-3">
                                        <div className="flex-1 min-w-0">
                                            <div className="flex items-center gap-2 mb-1.5">
                                                <div className={`w-2 h-2 rounded-full shadow-[0_0_5px_currentColor] print:shadow-none ${isPending ? 'bg-amber-500 text-amber-500' : isInProgress ? 'bg-blue-500 text-blue-500' : 'bg-emerald-500 text-emerald-500'}`}></div>
                                                {getPriorityBadge(incident.priority)}
                                                <span className="text-[10px] text-slate-600 font-mono font-tech ml-auto print:text-gray-500">#{incident.id.toString().padStart(4, '0')}</span>
                                            </div>
                                            <h3 className={`text-sm font-semibold mb-1 leading-snug ${isDone ? 'text-slate-400' : 'text-slate-100'} line-clamp-2 print:line-clamp-none print:text-black print:whitespace-normal`}>{incident.description}</h3>
                                            <div className="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-slate-400 mt-2 print:text-gray-700">
                                                <span className="flex items-center gap-1"><MapPin size={11} className="text-cyan-600 print:text-black" /> {incident.buildingName} {incident.roomNumber && <span className="text-slate-500 print:text-gray-600">({incident.roomNumber})</span>}</span>
                                                <span className="flex items-center gap-1">
                                                    <Clock size={11} className="text-slate-600 print:text-black" />
                                                    <span className="print:hidden">{formatRelativeTime(incident.timestamp)}</span>
                                                    <span className="hidden print:inline">{formatFullDate(incident.timestamp)}</span>
                                                </span>
                                                <span className="flex items-center gap-1"><User size={11} className="text-purple-600 print:text-black" /> {incident.reporterName}</span>
                                            </div>
                                            {incident.imageUrl && <div className="mt-3 print:hidden"><button onClick={(e) => { e.stopPropagation(); setExpandedImage(incident.imageUrl); }} className="flex items-center gap-2 text-xs text-cyan-400 hover:text-cyan-300 border border-cyan-900/50 bg-cyan-950/30 px-2 py-1 rounded transition-colors group/img"><ImageIcon size={12} /> ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</button></div>}
                                        </div>
                                        {isAdmin && onDeleteClick && <div className="print:hidden opacity-0 group-hover:opacity-100 transition-opacity"><HoldButton onAction={() => onDeleteClick(incident.id)} className="text-slate-700 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-500/10 transition-colors" duration={1000}><Trash2 size={16} /></HoldButton></div>}
                                    </div>
                                    {!isDone && (
                                        <div className="mt-3 flex gap-2 print:hidden">
                                            {isPending && <button onClick={() => { playClickSound(); onAssignClick(incident.id); }} className="flex-1 text-xs py-1.5 rounded bg-blue-600 hover:bg-blue-500 text-white shadow-lg font-medium flex items-center justify-center gap-1.5"><Wrench size={12} /> ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢</button>}
                                            {isInProgress && <button onClick={() => { playClickSound(); onCompleteClick(incident.id); }} className="flex-1 text-xs py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg font-medium flex items-center justify-center gap-1.5"><CheckCircle size={12} /> ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // ... (WeeklySummary, MaterialSummary, ControlPanel, ReportView, TechnicianView, LoginScreen, AssignTeamModal, App)
        // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏ú‡∏°‡∏à‡∏∞‡∏£‡∏ß‡∏° Component ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...
        
        const WeeklySummary = ({ incidents }) => {
            const days = Array.from({ length: 7 }, (_, i) => { const d = new Date(); d.setDate(d.getDate() - (6 - i)); return d; });
            const chartData = days.map(date => {
                const dayStart = new Date(date.setHours(0, 0, 0, 0)).getTime();
                const dayEnd = new Date(date.setHours(23, 59, 59, 999)).getTime();
                const dayIncidents = incidents.filter(i => i.timestamp >= dayStart && i.timestamp <= dayEnd);
                const doneCount = dayIncidents.filter(i => i.status === 'Done').length;
                const pendingCount = dayIncidents.filter(i => i.status !== 'Done').length;
                return { label: date.toLocaleDateString('th-TH', { weekday: 'short' }), total: doneCount + pendingCount, done: doneCount, pending: pendingCount };
            });
            const maxVal = Math.max(...chartData.map(d => d.total), 5);
            return (
                <div className="glass-panel rounded-xl p-5 h-full flex flex-col">
                    <h2 className="text-sm font-bold text-white mb-4 flex items-center gap-2 uppercase tracking-wider"><BarChart3 className="text-indigo-400" size={18} /> ‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</h2>
                    <div className="flex-1 flex items-end justify-between gap-2 min-h-[160px] pb-4 pt-4 border-b border-white/5 relative">
                        {chartData.map((d, i) => {
                            const heightPercent = (d.total / maxVal) * 100;
                            const donePercent = d.total > 0 ? (d.done / d.total) * 100 : 0;
                            return (
                                <div key={i} className="flex flex-col items-center flex-1 h-full justify-end group z-10">
                                    <div className="w-full max-w-[18px] rounded-t-sm bg-slate-800/50 relative overflow-hidden transition-all duration-500" style={{ height: `${heightPercent}%` }}>
                                        <div className="absolute bottom-0 left-0 right-0 bg-emerald-500 transition-all duration-500" style={{ height: `${donePercent}%` }}></div>
                                        <div className="absolute top-0 left-0 right-0 bg-blue-500 transition-all duration-500" style={{ height: `${100 - donePercent}%` }}></div>
                                    </div>
                                    <div className="mt-2 text-[10px] text-white font-bold uppercase font-mono drop-shadow-md">{d.label}</div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const MaterialSummary = ({ incidents }) => {
            const partTotals = {};
            incidents.forEach(inc => { if (inc.status === 'Done' && inc.usedParts) inc.usedParts.forEach(p => { if (!partTotals[p.id]) partTotals[p.id] = { ...p, quantity: 0 }; partTotals[p.id].quantity += p.quantity; }); });
            const sortedParts = Object.values(partTotals).sort((a, b) => b.quantity - a.quantity);
            return (
                <div className="glass-panel rounded-xl p-5 h-full flex flex-col">
                    <h2 className="text-sm font-bold text-white flex items-center gap-2 uppercase tracking-wider"><Package className="text-indigo-400" size={18} /> ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏™‡∏î‡∏∏</h2>
                    <div className="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2 mt-2">
                        {sortedParts.map((part, idx) => (
                            <div key={idx} className="flex justify-between items-center p-2 rounded bg-slate-900/40 border border-white/5">
                                <span className="text-xs text-slate-300">{part.name}</span>
                                <span className="text-sm font-bold text-cyan-400 font-tech">{part.quantity} <span className="text-[10px] text-slate-500">{part.unit}</span></span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ControlPanel = ({ teams, incidents, isAdmin = false, registeredUsers = [], onResetSystem, onInspectTeam, onExportData, onImportData, onApproveUser, onRejectUser, addToast }) => {
            const fileInputRef = useRef(null);
            const pendingCount = incidents.filter(i => i.status === 'Pending').length;
            const progressCount = incidents.filter(i => i.status === 'In Progress').length;
            const doneCount = incidents.filter(i => i.status === 'Done').length;
            const pendingUsers = registeredUsers.filter(u => u.status === 'pending');
            
            return (
                <div className="flex flex-col gap-4 h-full overflow-y-auto custom-scrollbar pr-1 pb-4">
                     <div className="flex items-center gap-3 px-2 py-1 mb-2"><div className="w-10 h-10 drop-shadow-md"><SchoolLogo /></div><div><h2 className="text-sm font-bold text-slate-800 uppercase tracking-wider">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å</h2><p className="text-[10px] text-slate-500 font-tech font-bold">ADMIN CONTROL CENTER</p></div></div>
                     <div className="grid grid-cols-3 gap-3">
                        <div className="glass-panel p-4 rounded-xl relative overflow-hidden group hover:bg-amber-950/20 transition-colors"><div className="text-amber-400 font-bold text-3xl font-tech">{pendingCount}</div><div className="text-[10px] text-slate-400 font-bold tracking-wider mt-1 uppercase">‡∏£‡∏≠‡∏à‡∏±‡∏î‡∏™‡∏£‡∏£</div></div>
                        <div className="glass-panel p-4 rounded-xl relative overflow-hidden group hover:bg-blue-950/20 transition-colors"><div className="text-blue-400 font-bold text-3xl font-tech">{progressCount}</div><div className="text-[10px] text-slate-400 font-bold tracking-wider mt-1 uppercase">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°</div></div>
                        <div className="glass-panel p-4 rounded-xl relative overflow-hidden group hover:bg-emerald-950/20 transition-colors"><div className="text-emerald-400 font-bold text-3xl font-tech">{doneCount}</div><div className="text-[10px] text-slate-400 font-bold tracking-wider mt-1 uppercase">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div></div>
                     </div>
                     {isAdmin && pendingUsers.length > 0 && (
                         <div className="glass-panel rounded-xl p-5 border-cyan-500/30 bg-cyan-950/10">
                             <h3 className="text-xs font-bold text-cyan-300 mb-3 flex items-center gap-2 uppercase tracking-wider"><UserPlus size={14} /> ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà ({pendingUsers.length})</h3>
                             <div className="space-y-2">{pendingUsers.map(u => (
                                 <div key={u.username} className="bg-slate-900/80 border border-cyan-500/20 p-3 rounded-lg flex items-center justify-between shadow-lg">
                                     <div><div className="text-xs font-bold text-white">{u.name}</div><div className="text-[10px] text-slate-400">{u.gradeLevel}</div></div>
                                     <div className="flex gap-2"><button onClick={() => { onApproveUser(u.username); addToast('success', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }} className="p-1.5 bg-emerald-600 text-white rounded"><Check size={14}/></button><button onClick={() => { onRejectUser(u.username); addToast('info', '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }} className="p-1.5 bg-red-600 text-white rounded"><X size={14}/></button></div>
                                 </div>
                             ))}</div>
                         </div>
                     )}
                     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-1 gap-4">
                         <div className="h-64 shrink-0"><WeeklySummary incidents={incidents} /></div>
                         <div className="h-64 shrink-0"><MaterialSummary incidents={incidents} /></div>
                     </div>
                     <div className="glass-panel rounded-xl p-5 flex-1 min-h-[300px]">
                         <h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2 uppercase tracking-wider"><Users size={18} className="text-indigo-400" /> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á</h3>
                         <div className="space-y-3">{teams.map(team => {
                             const isBusy = team.status === 'Busy';
                             return (
                                 <div key={team.id} className="bg-slate-900/40 border border-white/5 rounded-lg p-3 transition-all hover:border-white/10 group">
                                     <div className="flex justify-between items-center mb-2"><div className="font-semibold text-slate-200 text-sm tracking-wide">{team.name}</div><div className={`text-[10px] px-2 py-0.5 rounded border font-bold tracking-wider ${isBusy ? 'bg-amber-500/10 border-amber-500/50 text-amber-400' : 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400'}`}>{isBusy ? '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á' : '‡∏ß‡πà‡∏≤‡∏á'}</div></div>
                                     {isAdmin && onInspectTeam && <button onClick={() => { playClickSound(); onInspectTeam(team.id); }} className="w-full mt-2 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-cyan-300 border border-slate-700 rounded text-[10px] font-bold uppercase tracking-wider flex items-center justify-center gap-2 transition-all opacity-60 group-hover:opacity-100"><Eye size={12} /> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Inspect)</button>}
                                 </div>
                             )
                         })}</div>
                     </div>
                     {isAdmin && (
                         <div className="rounded-xl p-5 border border-slate-300/50 bg-white/60 shadow-sm backdrop-blur-sm mt-2">
                             <h3 className="text-xs font-bold text-slate-800 mb-3 flex items-center gap-2 uppercase tracking-wider"><Database size={14} className="text-blue-600" /> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Database)</h3>
                             <div className="grid grid-cols-2 gap-2">
                                 <button onClick={() => { playClickSound(); onExportData(); }} className="py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-600 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 shadow-sm"><Download size={14} /> Export</button>
                                 <button onClick={() => { playClickSound(); fileInputRef.current.click(); }} className="py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 border border-slate-600 rounded-lg text-xs font-bold transition-all flex items-center justify-center gap-2 shadow-sm"><Upload size={14} /> Import</button>
                                 <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={onImportData} />
                             </div>
                         </div>
                     )}
                     {isAdmin && (
                         <div className="rounded-xl p-5 border border-red-300/50 bg-red-50/60 shadow-sm backdrop-blur-sm mt-2">
                             <h3 className="text-xs font-bold text-slate-800 mb-3 flex items-center gap-2 uppercase tracking-wider"><AlertTriangle size={14} className="text-red-600" /> Danger Zone</h3>
                             <HoldButton onAction={() => { onResetSystem(); addToast('error', '‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÅ‡∏•‡πâ‡∏ß'); }} className="w-full py-3 bg-white hover:bg-red-50 text-red-600 hover:text-red-700 border border-red-200 hover:border-red-300 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-sm" progressClassName="bg-red-500/20" duration={3000}><RefreshCw size={14} /> ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á 3 ‡∏ß‡∏¥ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö</HoldButton>
                         </div>
                     )}
                </div>
            );
        };

        const ReportView = ({ currentUser, onSubmit, incidents = [] }) => {
            const [formData, setFormData] = useState({ buildingId: '', roomNumber: '', description: '', priority: 'Medium', reporterName: currentUser.name, imageUrl: '' });
            const [isCompressing, setIsCompressing] = useState(false);
            const fileInputRef = useRef(null);
            
            const handleSubmit = (e) => {
                e.preventDefault(); playClickSound(); onSubmit(formData);
                setFormData({ buildingId: '', roomNumber: '', description: '', priority: 'Medium', reporterName: currentUser.name, imageUrl: '' });
            };

            const myIncidents = incidents.filter(i => i.reporterName === currentUser.name).sort((a,b) => b.timestamp - a.timestamp).slice(0,5);
            
            const handleImage = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    setIsCompressing(true);
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (ev) => {
                        const img = new Image();
                        img.src = ev.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX = 800;
                            let w = img.width, h = img.height;
                            if (w > h) { if (w > MAX) { h *= MAX/w; w = MAX; } } else { if (h > MAX) { w *= MAX/h; h = MAX; } }
                            canvas.width = w; canvas.height = h;
                            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                            setFormData(prev => ({ ...prev, imageUrl: canvas.toDataURL('image/jpeg', 0.6) }));
                            setIsCompressing(false);
                        }
                    }
                }
            };

            return (
                <div className="max-w-2xl mx-auto w-full space-y-6">
                    <div className="glass-panel rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.3)] overflow-hidden">
                        <div className="p-6 border-b border-white/5 bg-gradient-to-r from-blue-900/30 to-transparent relative"><h2 className="text-xl font-bold text-white flex items-center gap-3 tracking-widest text-glow relative z-10"><ClipboardPen className="text-cyan-400" /> ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2></div>
                        <form onSubmit={handleSubmit} className="p-8 space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <div className="space-y-2"><label className="text-xs font-bold text-cyan-300 uppercase tracking-wider flex items-center gap-2"><MapPin size={14} /> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà / ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ <span className="text-red-400">*</span></label><select required value={formData.buildingId} onChange={e => setFormData({...formData, buildingId: e.target.value})} className="w-full bg-slate-950/60 border border-slate-700 rounded p-3 text-slate-200 text-sm outline-none"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ --</option>{BUILDINGS.map(b => ( <option key={b.id} value={b.id}>{b.name}</option> ))}</select></div>
                                <div className="space-y-2"><label className="text-xs font-bold text-slate-400 uppercase tracking-wider">‡∏´‡πâ‡∏≠‡∏á / ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label><input type="text" value={formData.roomNumber} onChange={e => setFormData({...formData, roomNumber: e.target.value})} className="w-full bg-slate-950/60 border border-slate-700 rounded p-3 text-slate-200 text-sm outline-none" /></div>
                            </div>
                            <div className="space-y-2"><label className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î <span className="text-red-400">*</span></label><textarea required rows={4} value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full bg-slate-950/60 border border-slate-700 rounded p-3 text-slate-200 text-sm outline-none" /></div>
                            <div className="space-y-2"><label className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2"><Camera size={14} /> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label><div onClick={() => fileInputRef.current?.click()} className="w-full border-2 border-dashed border-slate-700 rounded-xl p-4 text-center cursor-pointer hover:border-cyan-500/50">{formData.imageUrl ? <img src={formData.imageUrl} className="h-32 mx-auto rounded" /> : (isCompressing ? 'Compressing...' : 'Click to upload')}</div><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImage} /></div>
                            <button type="submit" disabled={isCompressing} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded shadow-lg transition-all uppercase tracking-widest">‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
                        </form>
                    </div>
                    {myIncidents.length > 0 && <div className="glass-panel rounded-2xl p-6"><h3 className="text-sm font-bold text-white mb-4 flex items-center gap-2 uppercase tracking-wider"><History className="text-indigo-400" size={18} /> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3><div className="space-y-3">{myIncidents.map(inc => (<div key={inc.id} className="bg-slate-900/40 border border-white/5 p-3 rounded-lg flex items-center justify-between"><div className="text-xs font-medium text-slate-200">{inc.description}</div><div className="text-[10px] bg-slate-800 px-2 py-0.5 rounded">{inc.status}</div></div>))}</div></div>}
                </div>
            );
        };

        const TechnicianView = ({ user, teams, incidents, onCompleteJob, onRushJob, addToast }) => {
            const [note, setNote] = useState('');
            const [selectedPartId, setSelectedPartId] = useState(AVAILABLE_PARTS[0].id);
            const [quantity, setQuantity] = useState(1);
            const [addedParts, setAddedParts] = useState([]);
            const [expandedImage, setExpandedImage] = useState(null);
            
            const myTeam = teams.find(t => t.id === user.teamId);
            const currentJob = myTeam?.currentIncidentId ? incidents.find(i => i.id === myTeam.currentIncidentId) : null;
            const handleAddPart = () => { setAddedParts([...addedParts, { ...AVAILABLE_PARTS.find(p => p.id === selectedPartId), quantity }]); setQuantity(1); };

            return (
                <div className="max-w-xl mx-auto w-full pb-24 space-y-6">
                    {expandedImage && <div className="fixed inset-0 z-[100] bg-black/90 flex items-center justify-center p-4" onClick={() => setExpandedImage(null)}><img src={expandedImage} className="max-w-full max-h-full rounded-lg" /></div>}
                    <div className="glass-panel p-5 rounded-2xl flex items-center gap-4 border-l-4 border-l-cyan-500"><div className="bg-slate-800 p-3 rounded-full border border-slate-700"><Wrench className="text-cyan-400" size={24} /></div><div><h2 className="text-xl font-bold text-white">{user.name}</h2><div className="text-xs font-bold text-emerald-400">{myTeam?.status}</div></div></div>
                    {currentJob ? (
                        <div className={`rounded-2xl border overflow-hidden shadow-2xl relative ${currentJob.isRushed ? 'bg-red-900/20 border-red-500 animate-pulse' : 'bg-slate-900 border-slate-700'}`}>
                            <div className="p-4 border-b border-white/10 flex justify-between"><h3 className="text-lg font-bold text-white">{currentJob.description}</h3><div className="text-xl font-bold text-white font-tech">#{currentJob.id}</div></div>
                            <div className="p-5 relative z-10">
                                {user.role === 'admin' && onRushJob && !currentJob.isRushed && <HoldButton onAction={() => onRushJob(currentJob.id)} className="w-full mb-4 bg-red-600 text-white font-bold py-3 rounded-lg" duration={1500}><Zap size={18} /> Hold to Rush</HoldButton>}
                                <div className="grid grid-cols-2 gap-4 mb-4"><div className="bg-slate-950/50 p-3 rounded-xl"><div className="text-cyan-100 font-bold">{currentJob.buildingName}</div></div><div className="bg-slate-950/50 p-3 rounded-xl"><div className="text-cyan-100 font-bold">{formatRelativeTime(currentJob.timestamp)}</div></div></div>
                                {currentJob.imageUrl && <div className="mt-4"><div className="h-40 rounded-xl overflow-hidden bg-black/50 cursor-pointer" onClick={() => setExpandedImage(currentJob.imageUrl)}><img src={currentJob.imageUrl} className="w-full h-full object-cover" /></div></div>}
                            </div>
                            <div className="glass-panel rounded-2xl p-5 space-y-5 m-2">
                                <div>
                                    <div className="flex gap-2 mb-2"><select value={selectedPartId} onChange={e => setSelectedPartId(e.target.value)} className="flex-1 bg-slate-950 text-white p-2 rounded">{AVAILABLE_PARTS.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select><button onClick={handleAddPart} className="bg-blue-600 text-white p-2 rounded">Add</button></div>
                                    {addedParts.map((p, i) => <div key={i} className="text-slate-300 text-sm">{p.name} x{p.quantity}</div>)}
                                </div>
                                <textarea value={note} onChange={e => setNote(e.target.value)} placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô..." className="w-full bg-slate-950/60 border border-slate-700 rounded-xl p-4 text-white outline-none h-24" />
                                <HoldButton onAction={() => { onCompleteJob(currentJob.id, note, addedParts); addToast('success', '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold text-lg py-4 rounded-xl shadow-lg flex items-center justify-center gap-3" duration={1500}><CheckCircle size={24} /> Hold to Complete</HoldButton>
                            </div>
                        </div>
                    ) : <div className="glass-panel p-10 text-center text-slate-300">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>}
                </div>
            );
        };

        const AssignTeamModal = ({ isOpen, incident, teams, onClose, onAssign }) => {
            if (!isOpen || !incident) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-md">
                    <div className="glass-panel w-full max-w-md rounded-2xl p-6 border border-white/10">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-lg font-bold text-white uppercase">‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡∏°‡∏ä‡πà‡∏≤‡∏á</h2><button onClick={onClose}><X size={20} className="text-slate-500 hover:text-white" /></button></div>
                        <div className="space-y-2">{teams.map(team => (
                            <button key={team.id} disabled={team.status !== 'Available'} onClick={() => team.status === 'Available' && onAssign(team.id, incident.id)} className={`w-full p-3 rounded text-left ${team.status === 'Available' ? 'bg-slate-900 hover:bg-cyan-900/50 text-white' : 'bg-black/50 text-slate-600'}`}>{team.name} ({team.status})</button>
                        ))}</div>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ onLogin, onRegister, onGuestLogin }) => {
            const [mode, setMode] = useState('login'); // login, register, guest
            const [role, setRole] = useState('teacher');
            const [formData, setFormData] = useState({ username: '', password: '', name: '', email: '', phone: '', grade: '' });
            const [guestName, setGuestName] = useState('');

            const handleLogin = (e) => {
                e.preventDefault(); playClickSound();
                if (role === 'admin') onLogin(formData.username, formData.password, 'admin');
                else if (role === 'technician') onLogin(formData.username, formData.password, 'technician'); // Password acts as verification
                else onLogin(formData.username, formData.password, 'teacher');
            };

            if (mode === 'register') {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="glass-panel p-8 rounded-2xl w-full max-w-md">
                            <h2 className="text-2xl text-white font-bold mb-4">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà</h2>
                            <input placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" className="w-full mb-3 p-3 rounded bg-slate-950 text-white" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                            <input placeholder="Username" className="w-full mb-3 p-3 rounded bg-slate-950 text-white" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
                            <input type="password" placeholder="Password" className="w-full mb-3 p-3 rounded bg-slate-950 text-white" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                            <select className="w-full mb-3 p-3 rounded bg-slate-950 text-white" value={formData.grade} onChange={e => setFormData({...formData, grade: e.target.value})}>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏ä‡∏±‡πâ‡∏ô</option>
                                {TEACHER_GRADE_LEVELS.map(g => <option key={g} value={g}>{g}</option>)}
                            </select>
                            <button onClick={() => onRegister({ ...formData, role: 'teacher', status: 'pending', createdAt: Date.now() })} className="w-full bg-cyan-600 text-white p-3 rounded font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>
                            <button onClick={() => setMode('login')} className="w-full mt-2 text-slate-400">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">
                    <div className="glass-panel p-8 rounded-2xl w-full max-w-md relative z-10">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 mx-auto mb-4 text-cyan-400"><SchoolLogo /></div>
                            <h1 className="text-2xl font-bold text-white">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>
                            <p className="text-cyan-200">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏°‡∏≤‡∏ö‡∏≠‡∏≥‡∏°‡∏§‡∏ï</p>
                        </div>
                        
                        {mode === 'guest' ? (
                            <div>
                                <h3 className="text-white font-bold mb-2">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏î‡πà‡∏ß‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô)</h3>
                                <input placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á..." className="w-full mb-4 p-3 rounded bg-slate-950 text-white" value={guestName} onChange={e => setGuestName(e.target.value)} />
                                <button onClick={() => onGuestLogin(guestName)} className="w-full bg-amber-600 text-white p-3 rounded font-bold mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button>
                                <button onClick={() => setMode('login')} className="w-full text-slate-400">‡∏Å‡∏•‡∏±‡∏ö</button>
                            </div>
                        ) : (
                            <form onSubmit={handleLogin}>
                                <div className="flex mb-4 bg-slate-950 p-1 rounded-lg">
                                    {['teacher', 'admin', 'technician'].map(r => (
                                        <button type="button" key={r} onClick={() => setRole(r)} className={`flex-1 py-2 rounded text-xs font-bold uppercase ${role === r ? 'bg-cyan-700 text-white' : 'text-slate-500'}`}>{r}</button>
                                    ))}
                                </div>
                                <input placeholder="Username" className="w-full mb-3 p-3 rounded bg-slate-950 text-white" value={formData.username} onChange={e => setFormData({...formData, username: e.target.value})} />
                                <input type="password" placeholder="Password" className="w-full mb-3 p-3 rounded bg-slate-950 text-white" value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                                <button type="submit" className="w-full bg-blue-600 text-white p-3 rounded font-bold mb-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                                {role === 'teacher' && (
                                    <>
                                        <button type="button" onClick={() => setMode('guest')} className="w-full bg-amber-600/20 text-amber-500 border border-amber-500/50 p-2 rounded mb-2 text-sm font-bold">‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏î‡πà‡∏ß‡∏ô (Guest)</button>
                                        <button type="button" onClick={() => setMode('register')} className="w-full text-slate-400 text-sm">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏£‡∏π‡πÉ‡∏´‡∏°‡πà</button>
                                    </>
                                )}
                            </form>
                        )}
                    </div>
                    <div className="mt-8 text-center opacity-80 z-10">
                        <div className="text-[10px] text-slate-700 font-bold tracking-wider">‡∏ô‡∏≤‡∏¢‡∏Å‡∏≤‡∏ô‡∏ï‡πå ‡πÇ‡∏™‡∏°‡∏™‡∏±‡∏¢ ‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
                        <div className="text-[9px] text-slate-500">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏°‡∏≤‡∏ö‡∏≠‡∏≥‡∏°‡∏§‡∏ï ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏∏‡∏°‡∏û‡∏£ ‡πÄ‡∏Ç‡∏ï 1</div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [incidents, setIncidents] = useState([]);
            const [teams, setTeams] = useState(INITIAL_TEAMS);
            const [registeredUsers, setRegisteredUsers] = useState([]);
            const [selectedBuildingId, setSelectedBuildingId] = useState(null);
            const [assignModalOpen, setAssignModalOpen] = useState(false);
            const [targetIncidentId, setTargetIncidentId] = useState(null);
            const [toasts, setToasts] = useState([]);
            const [inspectingTeamId, setInspectingTeamId] = useState(null);

            const addToast = (type, message) => {
                const id = Date.now().toString();
                setToasts(prev => [...prev, { id, type, message }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 4000);
            };

            useEffect(() => {
                const savedIncidents = localStorage.getItem('school_incidents');
                const savedTeams = localStorage.getItem('school_teams');
                const savedUsers = localStorage.getItem('school_registered_users');
                if (savedIncidents) setIncidents(JSON.parse(savedIncidents));
                if (savedTeams) setTeams(JSON.parse(savedTeams));
                if (savedUsers) setRegisteredUsers(JSON.parse(savedUsers));
            }, []);

            useEffect(() => {
                localStorage.setItem('school_incidents', JSON.stringify(incidents));
                localStorage.setItem('school_teams', JSON.stringify(teams));
                localStorage.setItem('school_registered_users', JSON.stringify(registeredUsers));
            }, [incidents, teams, registeredUsers]);

            const handleLogin = (username, password, role) => {
                if (role === 'admin') {
                    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                        setCurrentUser({ name: 'Admin', role: 'admin' }); return true;
                    }
                } else if (role === 'technician') {
                    const tech = TECHNICIAN_ACCOUNTS.find(t => t.username === username && t.password === password);
                    if (tech) { setCurrentUser({ ...tech, role: 'technician' }); return true; }
                } else {
                    const user = registeredUsers.find(u => u.username === username && u.password === password && u.status === 'approved');
                    if (user) { setCurrentUser(user); return true; }
                }
                return false;
            };

            const handleRegister = (user) => {
                setRegisteredUsers([...registeredUsers, user]);
                addToast('success', '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
                return true;
            };

            const handleGuestLogin = (name) => {
                setCurrentUser({ name: `${name} (Guest)`, role: 'teacher', gradeLevel: 'Urgent' });
            };

            const handleLogout = () => setCurrentUser(null);

            // ... (Other handlers: handleNewReport, handleAssignTeam, handleCompleteJob, etc. implemented similarly to previous separate files)
            // Simplified for the monolithic block:

            const handleNewReport = (data) => {
                const newIncident = { ...data, id: Date.now(), status: 'Pending', timestamp: Date.now() };
                setIncidents([newIncident, ...incidents]);
                addToast('success', '‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß');
            };

            const handleAssignTeam = (teamId, incidentId) => {
                setTeams(teams.map(t => t.id === teamId ? { ...t, status: 'Busy', currentIncidentId: incidentId } : t));
                setIncidents(incidents.map(i => i.id === incidentId ? { ...i, status: 'In Progress', assignedTeamId: teamId } : i));
                setAssignModalOpen(false);
            };

            const handleCompleteJob = (incidentId, note, parts) => {
                const inc = incidents.find(i => i.id === incidentId);
                setTeams(teams.map(t => t.id === inc.assignedTeamId ? { ...t, status: 'Available', currentIncidentId: null } : t));
                setIncidents(incidents.map(i => i.id === incidentId ? { ...i, status: 'Done', completedAt: Date.now(), completionNote: note, usedParts: parts } : i));
            };

            if (!currentUser) return (
                <>
                    <ToastContainer toasts={toasts} removeToast={(id) => setToasts(toasts.filter(t => t.id !== id))} />
                    <LoginScreen onLogin={handleLogin} onRegister={handleRegister} onGuestLogin={handleGuestLogin} />
                </>
            );

            return (
                <div className="min-h-screen pb-6 print:bg-white">
                    <ToastContainer toasts={toasts} removeToast={(id) => setToasts(toasts.filter(t => t.id !== id))} />
                    <div className="print:hidden"><Header user={currentUser} onLogout={handleLogout} /></div>
                    <main className="container mx-auto p-4 mt-16 print:mt-0">
                        {currentUser.role === 'teacher' && <ReportView currentUser={currentUser} onSubmit={handleNewReport} incidents={incidents} />}
                        {currentUser.role === 'technician' && <TechnicianView user={currentUser} teams={teams} incidents={incidents} onCompleteJob={handleCompleteJob} addToast={addToast} />}
                        {currentUser.role === 'admin' && (
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-5 h-[calc(100vh-100px)]">
                                <div className="lg:col-span-3 print:hidden"><BuildingGrid incidents={incidents} selectedBuildingId={selectedBuildingId} onSelectBuilding={setSelectedBuildingId} /></div>
                                <div className="lg:col-span-6 print:w-full"><IncidentList incidents={selectedBuildingId ? incidents.filter(i => i.buildingId === selectedBuildingId) : incidents} onAssignClick={(id) => { setTargetIncidentId(id); setAssignModalOpen(true); }} isAdmin={true} /></div>
                                <div className="lg:col-span-3 print:hidden"><ControlPanel teams={teams} incidents={incidents} isAdmin={true} registeredUsers={registeredUsers} onApproveUser={(u) => setRegisteredUsers(registeredUsers.map(r => r.username === u ? { ...r, status: 'approved' } : r))} onRejectUser={(u) => setRegisteredUsers(registeredUsers.filter(r => r.username !== u))} addToast={addToast} /></div>
                            </div>
                        )}
                    </main>
                    <AssignTeamModal isOpen={assignModalOpen} incident={incidents.find(i => i.id === targetIncidentId)} teams={teams} onClose={() => setAssignModalOpen(false)} onAssign={handleAssignTeam} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
